{% extends 'accounts/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-screen-xl mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row h-[80vh] bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Sidebar: All Messages -->
        <div class="hidden md:flex md:flex-col md:w-1/3 bg-gray-50 border-r h-full overflow-y-auto">
            <div class="flex items-center gap-2 p-4 border-b">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V10a2 2 0 012-2h2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3h-6a2 2 0 00-2 2v0a2 2 0 002 2h6a2 2 0 002-2v0a2 2 0 00-2-2z"/></svg>
                <span class="font-semibold text-gray-700">All Messages</span>
            </div>
            <div class="flex flex-col gap-2 p-4">
                <div class="flex items-center gap-3 p-2 rounded-lg bg-blue-100">
                    <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center font-bold text-blue-700 text-lg">
                        {{ reservation.dorm.name|slice:":1"|upper }}
                    </div>
                    <div>
                        <div class="font-semibold text-blue-900">{{ reservation.dorm.name }}</div>
                        <div class="text-xs text-gray-500">{{ reservation.dorm.address|truncatechars:30 }}</div>
                    </div>
                </div>
                <!-- For future: loop through all reservations here -->
            </div>
        </div>
        <!-- Chat/Main Section -->
        <div class="flex-1 flex flex-col h-full">
            <!-- Chat Header -->
            <div class="flex items-center gap-4 p-4 border-b bg-white">
                <div class="font-bold text-blue-900 text-lg">{{ reservation.dorm.name }}</div>
                <span class="ml-2 text-xs text-gray-500">This chat is monitored by the Dorm Finder Team.</span>
            </div>
            <!-- Reservation Info Card in Chat -->
            <div class="flex justify-end mt-4 pr-6">
                <div class="bg-white border-2 border-blue-400 rounded-2xl p-4 w-full max-w-xs shadow-lg">
                    <div class="text-xs text-orange-600 font-semibold mb-1">You inquired for</div>
                    <div class="flex items-center gap-2 mb-2">
                        {% if reservation.dorm.images.first %}
                            <img src="{{ reservation.dorm.images.first.image.url }}" class="w-10 h-10 rounded object-cover" alt="Dorm Image">
                        {% else %}
                            <div class="w-10 h-10 rounded bg-gray-200 flex items-center justify-center text-gray-400">üè†</div>
                        {% endif %}
                        <div>
                            <div class="font-bold text-blue-900 text-sm">{{ reservation.dorm.name }}</div>
                            <div class="text-xs text-gray-500">from {{ reservation.dorm.address|truncatechars:40 }}</div>
                        </div>
                    </div>
                    <div class="flex gap-2 mb-2">
                        <div class="flex-1 bg-blue-50 rounded-lg p-2">
                            <div class="text-[10px] text-gray-500">Target Move-In</div>
                            <div class="font-semibold text-blue-900">{{ reservation.reservation_date }}</div>
                        </div>
                        <div class="flex items-center justify-center text-xs font-bold text-gray-400">to</div>
                        <div class="flex-1 bg-blue-50 rounded-lg p-2">
                            <div class="text-[10px] text-gray-500">Target Move-Out</div>
                            <div class="font-semibold text-blue-900">{{ reservation.move_out_date|default:'---' }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Chat Messages -->
            <div class="flex-1 p-4 overflow-y-auto space-y-4" id="messages-container">
                {% for message in reservation.chat_messages.all %}
                <div class="flex items-end {% if message.sender == request.user %}justify-end{% endif %}">
                    <div class="max-w-[70%] px-4 py-2 rounded-2xl shadow-md
                        {% if message.sender == request.user %}bg-blue-100 text-blue-900 rounded-br-none{% else %}bg-blue-50 text-gray-900 rounded-bl-none{% endif %}">
                        <div class="flex items-center mb-1">
                            <span class="text-xs text-gray-400">{{ message.timestamp|date:"g:i A" }}</span>
                            <span class="text-xs ml-2 font-medium {% if message.sender == request.user %}text-blue-900{% else %}text-blue-700{% endif %}">
                                {{ message.sender.get_full_name|default:message.sender.username }}
                            </span>
                        </div>
                        <div class="break-words">{{ message.content }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Sticky Message Input -->
            {% if reservation.status != 'declined' and reservation.status != 'completed' %}
            <div class="p-4 border-t bg-gray-50 sticky bottom-0">
                <form id="message-form" class="flex gap-2">
                    {% csrf_token %}
                    <input type="text" id="message-input" name="content"
                        class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Type a message">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Auto-scroll to bottom of messages
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle message form submission
    const messageForm = document.getElementById('message-form');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content) return;
            
            const formData = new FormData();
            formData.append('content', content);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            formData.append('reservation_id', '{{ reservation.id }}');
            
            fetch(`/dormitory/messages/send/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Add message to UI
                    const messageHtml = `
                        <div class="flex items-end justify-end">
                            <div class="max-w-[70%] px-4 py-2 rounded-2xl shadow-md bg-blue-100 text-blue-900 rounded-br-none">
                                <div class="flex items-center mb-1">
                                    <span class="text-xs text-gray-400">${data.message.timestamp}</span>
                                    <span class="text-xs ml-2 font-medium text-blue-900">${data.message.sender_name}</span>
                                </div>
                                <div class="break-words">${data.message.content}</div>
                            </div>
                        </div>
                    `;
                    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    input.value = '';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
</script>
{% endblock %} 